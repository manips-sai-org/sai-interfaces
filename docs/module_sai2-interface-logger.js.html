<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: module/sai2-interface-logger.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: module/sai2-interface-logger.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Defines a custom HTML element to issue HTTP requests to start/stop
 * a background logger.
 * &lt;br>
 * Example usage:
 * &amp;lt;sai2-interface-logger /&amp;gt;
 * &lt;br>
 * Note: there are no available attributes to set.
 * 
 * @module ./module/sai2-interface-logger
 */


import { get_redis_all_keys } from '../redis.js';


const template = document.createElement('template');

template.innerHTML = `
  &lt;style>
    .sai2-interface-logger-top {
      display: flex;
      flex-direction: row;
      align-items: baseline;
      justify-content: space-evenly;
      flex-wrap: wrap;
    }

    .sai2-interface-logger-top > input {
      width: 32%;
    }

    .sai2-interface-logger-top > div {
      width: 32%;
    }

  &lt;/style>
  &lt;div class="sai2-interface-logger-top">
    &lt;input type="text" class="logfile" placeholder="log filename">
    &lt;input type="number" step="0.01" min="0" placeholder="1"
      class="logperiod" placeholder="(period, in seconds)">
    &lt;div>
      &lt;select multiple class="chosen_select" data-placeholder="Select keys to log...">&lt;/select>
    &lt;/div>
    &lt;button>&lt;/button>
  &lt;/div>
`;

customElements.define('sai2-interface-logger', class extends HTMLElement {
  constructor() {
    super();
    this.template = template;
    this.getLoggerStatus = this.getLoggerStatus.bind(this);
  }

  connectedCallback() {
    let template_node = this.template.content.cloneNode(true);
    
    let button = template_node.querySelector('button');
    let logfile_input = template_node.querySelector('.logfile');
    let logperiod_input = template_node.querySelector('.logperiod');
    let keys_select = template_node.querySelector('select');

    this.getLoggerStatus().then(status => {
      this.logging = status['running'];
      button.innerHTML = this.logging ? 'stop logging' : 'start logging';
      button.className = this.logging ? "button-disable" : "button-enable";
    });

    button.innerHTML = this.logging ? 'stop logging' : 'start logging';
    button.className = this.logging ? "button-disable" : "button-enable";

    // populate keys list
    get_redis_all_keys().then(keys => {
      for (let key of keys.values()) {
        let opt = document.createElement('option');
        opt.value = key;
        opt.innerHTML = key;
        keys_select.append(opt);
      }

      $('.chosen_select').chosen({width: '100%'});
    });

    // set up listeners
    button.onclick = () => {
      this.logging = !this.logging;
      if (this.logging) {
        // default to log.txt
        let filename = logfile_input.value || 'log.txt';

        // get selected keys
        let selected_keys = [];
        for (let option of keys_select.options)
          if (option.selected)
            selected_keys.push(option.value);

        // get logger period. default to 0.1s
        let logger_period = logperiod_input.value || 0.1;

        this.start_logging(filename, selected_keys, logger_period).then(() => {
          button.innerHTML = 'stop logging';
          button.className = "button-disable";
        });
      } else {
        this.stop_logging().then(() => {
          button.innerHTML = 'start logging';
          button.className = "button-enable"
        });
      }
    };
    
    // append to document
    this.appendChild(template_node);
  }
  
  /**
   * Sends a HTTP request to the server to query logger status.
   * @returns {Promise&lt;Object>} Promise with JSON object containig boolean key 'running'. 
   */
  getLoggerStatus() {
    let fetchOptions = {
      method: 'GET',
      headers: new Headers({'Content-Type': 'application/json'}),
      mode: 'same-origin'
    };

    return fetch('/logger/status', fetchOptions)
      .then(response => response.json())
      .catch(data => alert('logger error: ' + toString(data)));
  }

  /**
   * Sends a start logging HTTP request to the backend.
   * 
   * @param {string} filename Log file to write to. Need not exist.
   * @param {string[]} key_list List of Redis keys to query
   * @param {number} period How often to log, in seconds
   * @returns {Promise} Empty promise. Use this to execute actions after successful request.
   */
  start_logging(filename, key_list, period) {
    let fetchOptions = {
      method: 'POST',
      headers: new Headers({'Content-Type': 'application/json'}),
      mode: 'same-origin',
      body: JSON.stringify({
        filename: filename,
        keys: key_list,
        logger_period: period
      })
    };
  
    return fetch('/logger/start', fetchOptions)
      .then(response => response.ok)
      .catch(data => alert('logger redis error: ' + toString(data)));
  }

  /**
   * Sends a stop logging HTTP request to the backend.
   * @returns {Promise} Empty promise. Use this to execute actions after successful request.
   */
  stop_logging() {
    let fetchOptions = {
      method: 'POST',
      headers: new Headers({'Content-Type': 'application/json'}),
      mode: 'same-origin'
    };
  
    return fetch('/logger/stop', fetchOptions)
      .catch(data => alert('logger redis error: ' + toString(data)));
  }
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-._const.html">./const</a></li><li><a href="module-._module_sai2-interface-display.html">./module/sai2-interface-display</a></li><li><a href="module-._module_sai2-interface-enum.html">./module/sai2-interface-enum</a></li><li><a href="module-._module_sai2-interface-logger.html">./module/sai2-interface-logger</a></li><li><a href="module-._module_sai2-interface-plot.html">./module/sai2-interface-plot</a></li><li><a href="module-._module_sai2-interface-select.html">./module/sai2-interface-select</a></li><li><a href="module-._module_sai2-interface-slider.html">./module/sai2-interface-slider</a></li><li><a href="module-._module_sai2-interface-toggle.html">./module/sai2-interface-toggle</a></li><li><a href="module-._module_sai2-interface-trajectory-slider.html">./module/sai2-interface-trajectory-slider</a></li><li><a href="module-._redis.html">./redis</a></li><li><a href="module-._resize.html">./resize</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Wed Jul 24 2019 21:46:59 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
